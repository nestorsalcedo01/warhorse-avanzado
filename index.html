<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>War Horse: Advanced Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English:ital@0;1&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Rustic Neutrals with Subtle Gradient Background -->
    <!-- Application Structure Plan: SPA interactive quiz. Linear structure through 7 themed sections: 1. Warm-up & General Comprehension, 2. Plot and Key Events, 3. Character Analysis, 4. Themes and Messages, 5. Key Quote Identification, 6. Vocabulary and Author's Style, 7. Hypothetical and Creative Questions. Each section mixes question types (Multiple Choice, True/False, Sentence Ordering) to assess different facets of understanding. User flow involves answering and receiving instant feedback. Questions within sections are randomized on reset for replayability. This structure was chosen for comprehensive and progressive assessment of book knowledge, allowing users to explore different narrative angles. -->
    <!-- Visualization & Content Choices: 
        1. Multiple Choice/True-False (All sections): Goal: Assess factual recall, concept understanding, analysis. Viz/Pres: Clickable options in cards. Interaction: Click to check, visual feedback, explanation, score update. Justification: Intuitive, immediate reinforcement. Library: Vanilla JS, Tailwind.
        2. Sentence Ordering (Plot & Events): Goal: Assess understanding of chronology. Viz/Pres: Draggable text blocks, drop zone. Interaction: Drag-drop (mouse & touch), "Check Order" button. Justification: Tactile, interactive, requires sequential understanding, now mobile-friendly. Library: Vanilla JS, Tailwind.
        3. Quote Identification (Multiple Choice): Goal: Recognize important dialogues and their meaning/context. Viz/Pres: Quote + options (speaker/context). Interaction: Click. Justification: Highlights key moments. Library: Vanilla JS, Tailwind.
        4. Vocabulary & Style (Multiple Choice): Goal: Understand specific lexicon and stylistic elements. Viz/Pres: Word/concept + definition/analysis options. Interaction: Click. Justification: Enriches vocabulary and literary appreciation. Library: Vanilla JS, Tailwind.
        5. Hypothetical & Creative (Multiple Choice): Goal: Foster imaginative thinking and deep interpretation. Viz/Pres: "What if" scenarios + interpretive options. Interaction: Click. Justification: Promotes critical thinking. Library: Vanilla JS, Tailwind.
        6. Score Tracker: Goal: User progress. Viz/Pres: Fixed display. Interaction: Dynamic JS update. Justification: Clear performance feedback. Library: Vanilla JS, Tailwind. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Merriweather', serif;
            background-image: linear-gradient(to bottom right, #FDF8F0, #FAF5EF); /* Subtle gradient background */
            color: #374151; /* Gray-700 */
        }
        h1, h2, h3, h4 {
            font-family: 'IM Fell English', serif;
            color: #1F2937; /* Gray-800 */
        }
        .quiz-card {
            background-color: #FFFFFF;
            border: 1px solid #DED8CF; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            border-radius: 0.75rem; /* More rounded corners */
        }
        .option {
            border: 2px solid #E5E7EB; /* Gray-200 */
            transition: all 0.2s ease-in-out;
            border-radius: 0.5rem;
        }
        .option:hover {
            border-color: #A0522D; /* Sienna Brown - for hover */
            background-color: #FFFBF5; /* Lighter cream for hover */
        }
        .option.selected { /* This class might be redundant if direct feedback is given */
            border-color: #A0522D;
            background-color: #F5EFE6;
        }
        .option.correct {
            background-color: #E6FFFA; /* Mint cream - lighter green */
            border-color: #34D399; /* Emerald-400 */
            color: #065F46; /* Emerald-800 */
        }
        .option.incorrect {
            background-color: #FFF1F2; /* Rose white - lighter red */
            border-color: #F87171; /* Red-400 */
            color: #991B1B; /* Red-800 */
        }
        .explanation {
            background-color: #F8F9FA; /* Very light gray */
            border-left: 4px solid #A0522D; /* Sienna Brown accent */
            border-radius: 0.25rem;
            color: #4B5563; /* Gray-600 */
        }
        .draggable {
            cursor: move;
            user-select: none;
            border: 2px dashed #D1D5DB; /* Gray-300 */
            background-color: #F9FAFB;
            border-radius: 0.375rem;
        }
        .draggable.dragging, .draggable.touch-dragging {
            opacity: 0.6;
            box-shadow: 0px 5px 15px rgba(0,0,0,0.15);
            z-index: 1000; /* Ensure dragged item is on top */
        }
        .drop-zone {
            border: 3px dashed #A0522D; /* Sienna Brown dashed border */
            min-height: 160px;
            background-color: #FAF7F2; /* Slightly different cream for drop zone */
            border-radius: 0.5rem;
        }
        .score-tracker {
            background-color: #6B4226; /* Darker, richer brown */
            color: #FFFBF5; /* Lighter cream text */
            font-family: 'IM Fell English', serif;
            border-radius: 9999px; /* Pill shape */
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .button-primary {
            background-color: #795548; /* Muted Brown */
            color: white;
            transition: background-color 0.3s ease;
        }
        .button-primary:hover {
            background-color: #5D4037; /* Darker Muted Brown */
        }
        .no-select {
            -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
        }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-white py-8 shadow-lg">
        <div class="container mx-auto px-6">
            <h1 class="text-5xl md:text-6xl text-center text-gray-900 tracking-tight">War Horse: Advanced Quiz</h1>
            <p class="text-center text-gray-700 mt-3 text-lg">Test your deep knowledge of this poignant story.</p>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8">

        <section id="section-warmup" class="mb-16">
            <h2 class="text-4xl font-bold mb-8 border-b-4 border-[#A0522D] pb-3">Part 1: Warm-up & General Comprehension</h2>
            <p class="mb-6 text-gray-700 text-lg">Let's start with some questions to refresh your memory on the fundamental aspects of "War Horse." These cover the beginning of the story and main characters.</p>
            <div id="warmup-mc-container" class="space-y-10"></div>
            <div id="warmup-tf-container" class="mt-10 space-y-10"></div>
        </section>

        <section id="section-plot" class="mb-16">
            <h2 class="text-4xl font-bold mb-8 border-b-4 border-[#A0522D] pb-3">Part 2: Plot and Key Events</h2>
            <p class="mb-6 text-gray-700 text-lg">This section focuses on crucial events and narrative development throughout World War I. Pay attention to details and the sequence of events.</p>
            <div id="plot-mc-container" class="space-y-10"></div>
            <div id="plot-tf-container" class="mt-10 space-y-10"></div>
            <div id="plot-so-container" class="mt-10 space-y-10"></div>
        </section>

        <section id="section-characters" class="mb-16">
            <h2 class="text-4xl font-bold mb-8 border-b-4 border-[#A0522D] pb-3">Part 3: Character Analysis</h2>
            <p class="mb-6 text-gray-700 text-lg">Explore the motivations, relationships, and development of the human and equine characters Joey encounters on his journey. Consider how their actions impact the story.</p>
            <div id="characters-mc-container" class="space-y-10"></div>
            <div id="characters-tf-container" class="mt-10 space-y-10"></div>
        </section>

        <section id="section-themes" class="mb-16">
            <h2 class="text-4xl font-bold mb-8 border-b-4 border-[#A0522D] pb-3">Part 4: Themes and Messages</h2>
            <p class="mb-6 text-gray-700 text-lg">Reflect on the deeper meanings of the novel. What does "War Horse" tell us about war, friendship, loyalty, loss, and hope?</p>
            <div id="themes-mc-container" class="space-y-10"></div>
            <div id="themes-tf-container" class="mt-10 space-y-10"></div>
        </section>

        <section id="section-quotes" class="mb-16">
            <h2 class="text-4xl font-bold mb-8 border-b-4 border-[#A0522D] pb-3">Part 5: Key Quote Identification</h2>
            <p class="mb-6 text-gray-700 text-lg">Some phrases in "War Horse" are particularly memorable or revealing. Can you identify who said these quotes or in what context they were spoken?</p>
            <div id="quotes-mc-container" class="space-y-10"></div>
        </section>

        <section id="section-vocabulary" class="mb-16">
            <h2 class="text-4xl font-bold mb-8 border-b-4 border-[#A0522D] pb-3">Part 6: Vocabulary and Author's Style</h2>
            <p class="mb-6 text-gray-700 text-lg">Michael Morpurgo uses evocative language. This section tests your understanding of some specific words and the narrative style of the book.</p>
            <div id="vocabulary-mc-container" class="space-y-10"></div>
        </section>

        <section id="section-hypothetical" class="mb-16">
            <h2 class="text-4xl font-bold mb-8 border-b-4 border-[#A0522D] pb-3">Part 7: Hypothetical and Creative Questions</h2>
            <p class="mb-6 text-gray-700 text-lg">Use your imagination and understanding of the story to explore alternative scenarios or reflect on characters' decisions from a different perspective.</p>
            <div id="hypothetical-mc-container" class="space-y-10"></div>
            <div id="hypothetical-so-container" class="mt-10 space-y-10"></div>
        </section>

        <footer class="text-center mt-16">
            <button id="reset-quiz" class="button-primary font-bold py-4 px-10 rounded-lg shadow-xl transition-transform transform hover:scale-105 text-xl">Reset Quiz</button>
        </footer>
    </main>

    <div id="score-tracker" class="score-tracker fixed bottom-4 right-4 md:bottom-6 md:right-6 py-3 px-6 text-xl md:text-2xl">
        Score: <span id="score">0</span> / <span id="total-questions">0</span>
    </div>

    <script>
        const quizMasterData = {
            warmupMC: [
                { question: "What is the distinctive marking on Joey's forehead?", options: ["A white star", "A white blaze", "A white cross", "A white snip"], answer: "A white cross", explanation: "Joey is repeatedly described as having a remarkable white cross emblazoned on his forehead." },
                { question: "Who is Joey's first human companion and trainer on the farm?", options: ["Captain Nicholls", "Albert Narracott", "Albert's father", "Corporal Samuel Perkins"], answer: "Albert Narracott", explanation: "Albert forms an immediate and deep bond with Joey and lovingly trains him." },
                { question: "What color is Joey described as being?", options: ["Chestnut with a flaxen mane", "Dapple grey", "Splendid red bay", "Pitch black"], answer: "Splendid red bay", explanation: "The author's note and subsequent descriptions identify Joey as a red bay horse." },
                { question: "How old is Joey when he is first sold at the auction?", options: ["A newborn foal", "Nearly six months old", "Two years old", "A fully grown stallion"], answer: "Nearly six months old", explanation: "Joey recalls, 'I was not yet six months old, a gangling, leggy colt...'" },
                { question: "What is the initial reaction of Albert's father to buying Joey?", options: ["He is proud and excited", "He is indifferent", "He is drunk and bought Joey partly out of spite", "He immediately regrets the purchase"], answer: "He is drunk and bought Joey partly out of spite", explanation: "Albert's mother explains his father bought Joey to deny Farmer Easton, and he was harsh and drunk when he brought Joey home." }
            ],
            warmupTF: [
                { question: "Albert's father is consistently kind and gentle towards Joey from the beginning.", answer: false, explanation: "Albert's father is initially harsh, particularly when drunk, and his treatment of Joey is a source of conflict." },
                { question: "The Narracott farm is located in the county of Yorkshire, England.", answer: false, explanation: "The farm is in Devon, England. Joey later meets Topthorn, a horse from Devon, during the war." },
                { question: "Joey's mother is also sold at the same auction and he never sees her again.", answer: true, explanation: "Joey is traumatically separated from his mother at the auction and states, 'I was never to see her again.'" },
                { question: "Albert names Joey immediately upon seeing him for the first time.", answer: true, explanation: "Albert says, 'I shall call you Joey, only because it rhymes with Zoey... and then maybe because it suits you.'" },
                { question: "Zoey, the older farm horse, is hostile and unwelcoming to Joey when he first arrives.", answer: false, explanation: "Joey finds his 'one consolation' in Zoey, who 'nickerered gently' and showed him kindness." }
            ],
            plotMC: [
                { question: "Why does Albert's father ultimately decide to sell Joey to the army?", options: ["Joey was too difficult to handle on the farm.", "He desperately needed the money from the sale for the farm mortgage.", "Albert persuaded him that Joey would be a hero in the war.", "The army requisitioned all suitable horses from local farms."], answer: "He desperately needed the money from the sale for the farm mortgage.", explanation: "Albert's father tearfully admits to Captain Nicholls and later to Joey that he sold him because he 'needed the money bad' for the mortgage." },
                { question: "What is the name of the majestic black stallion who becomes Joey's closest equine companion during the war?", options: ["Warrior", "Black Jack", "Topthorn", "Midnight"], answer: "Topthorn", explanation: "Topthorn, Captain Stewart's horse, becomes Joey's steadfast friend and source of mutual support." },
                { question: "Which British officer, known for his kindness and artistic talent, is Joey's first rider in the cavalry?", options: ["Captain Stewart", "Major Martin", "Corporal Perkins", "Captain James Nicholls"], answer: "Captain James Nicholls", explanation: "Captain Nicholls sketches Joey, promises Albert he'll care for him, and is Joey's first officer in the war." },
                { question: "How is Joey eventually rescued from the perilous No Man's Land?", options: ["Albert single-handedly ventures out and brings him back.", "A British tank clears a path for his escape.", "A German soldier and a Welsh soldier cooperate, deciding his fate with a coin toss.", "He manages to find a hidden gap in the barbed wire on his own."], answer: "A German soldier and a Welsh soldier cooperate, deciding his fate with a coin toss.", explanation: "This iconic scene shows a moment of shared humanity as soldiers from opposing sides work together to save Joey." },
                { question: "What serious illness does Joey contract after being wounded in No Man's Land and later reunited with Albert?", options: ["Equine influenza", "Pneumonia", "Tetanus (Lock-jaw)", "Strangles"], answer: "Tetanus (Lock-jaw)", explanation: "His barbed wire wound becomes infected, leading to a life-threatening case of tetanus, from which he miraculously recovers." },
                { question: "Who is Trooper Warren?", options: ["Joey's first, very skilled cavalry rider", "A young, somewhat inexperienced soldier who becomes Joey's rider after Captain Nicholls' death", "The farrier who tends to Joey's hooves in the German army", "Albert's best friend who enlists with him"], answer: "A young, somewhat inexperienced soldier who becomes Joey's rider after Captain Nicholls' death", explanation: "Trooper Warren is kind but not a natural horseman; Joey notes his heavy seat but appreciates his gentle care." },
                { question: "What is the primary role Joey and Topthorn fulfill when they are first captured by the German army?", options: ["They become officers' personal mounts for parades.", "They are used to pull a heavy artillery gun.", "They are assigned to pull an ambulance cart, transporting wounded soldiers.", "They are sent to a breeding program due to their fine looks."], answer: "They are assigned to pull an ambulance cart, transporting wounded soldiers.", explanation: "Under the pragmatic German doctor and the reluctant Herr Hauptmann, they begin their service pulling a cart for stretcher cases." },
                { question: "What token of appreciation does a wounded German soldier give to Joey (and by extension, Topthorn)?", options: ["A handful of sugar cubes", "A regimental badge", "An Iron Cross medal", "A piece of his own bread ration"], answer: "An Iron Cross medal", explanation: "After they pull the ambulance through a heavy barrage, a grateful German soldier hangs his muddied Iron Cross around Joey's neck." },
                { question: "What happens to the kind German soldier Friedrich?", options: ["He deserts the army and escapes with Joey and Topthorn.", "He is killed in a bombardment shortly after Topthorn dies.", "He survives the war and writes to Emilie's grandfather.", "He is promoted for his bravery and care of the horses."], answer: "He is killed in a bombardment shortly after Topthorn dies.", explanation: "Tragically, Friedrich is killed by shellfire while trying to get Joey to safety, moments after Topthorn's death." },
                { question: "What is the final outcome of the auction for Joey at the end of the war?", options: ["Sergeant Thunder successfully buys him with the soldiers' pooled money.", "He is sold to the butcher from Cambrai.", "Emilie's grandfather appears and buys him, intending to keep his promise to Emilie.", "Albert manages to outbid everyone himself."], answer: "Emilie's grandfather appears and buys him, intending to keep his promise to Emilie.", explanation: "In a dramatic turn, Emilie's grandfather arrives and secures Joey, stating he will pay any price." }
            ],
            plotTF: [ // Balanced T/F for this section
                { question: "Captain Nicholls is killed in Joey's first cavalry charge.", answer: true, explanation: "Tragically, Captain Nicholls dies leading the charge, and Joey gallops on riderless for a short time." },
                { question: "Topthorn dies from a shrapnel wound during a heavy bombardment.", answer: false, explanation: "Topthorn dies from heart failure, weakened by illness and the hardships of war, while still in service with the German artillery." },
                { question: "Emilie fully recovers from her illness and is reunited with Joey after the war.", answer: false, explanation: "Emilie's grandfather sadly informs Albert that Emilie died the previous year." },
                { question: "The British and German soldiers in No Man's Land resolve the dispute over Joey through a brief skirmish.", answer: false, explanation: "Instead of fighting, a Welsh soldier and a German soldier engage in a remarkably civil discussion and decide Joey's fate with a coin toss." },
                { question: "Albert is able to buy Joey back from Emilie's grandfather for a substantial sum of money raised by his fellow soldiers.", answer: false, explanation: "Emilie's grandfather sells Joey to Albert for a symbolic one English penny and a solemn promise." },
                { question: "Joey's journey through the war takes him through France and Belgium.", answer: true, explanation: "Joey is shipped to France and participates in battles there. The initial news of war involved Germans marching into Belgium." },
                { question: "Albert is initially too young to enlist when he first tries to join the army.", answer: true, explanation: "Albert is turned away because he is under seventeen when he first attempts to join up to find Joey." },
                { question: "The conditions for horses in the German artillery unit were extremely harsh and led to many deaths.", answer: true, explanation: "This period is described as one of extreme hardship, with scarce food, constant exposure, and grueling work." },
                { question: "David, Albert's friend in the Veterinary Corps, is tragically killed by a stray shell.", answer: true, explanation: "Albert is devastated by the news of David's death, which occurred when a shell hit the veterinary wagon he was with." },
                { question: "After the war, Joey returns to working on the Narracott farm.", answer: true, explanation: "Joey returns to work on the land with old Zoey, though under Albert's loving care." }
            ],
            plotSO: [
                 { title: "Joey's Early Life and Sale", sentences: ["Joey is sold to Captain Nicholls by Albert's father.", "Albert and Joey form an unbreakable bond on the farm.", "Joey is bought by Albert's father at a horse sale.", "Albert makes his father promise never to hit Joey again after Joey kicks him."], correctOrder: ["Joey is bought by Albert's father at a horse sale.", "Albert and Joey form an unbreakable bond on the farm.", "Albert makes his father promise never to hit Joey again after Joey kicks him.", "Joey is sold to Captain Nicholls by Albert's father."] },
                 { title: "Key Moments in Joey's War Journey", sentences: ["Joey and Topthorn are cared for by Emilie and her grandfather on their French farm.", "Joey is wounded and lost in No Man's Land after Topthorn and Friedrich die.", "Captain Nicholls is killed, and Joey gets a new rider, Trooper Warren.", "Joey and Topthorn are captured by the German army after a disastrous cavalry charge."], correctOrder: ["Captain Nicholls is killed, and Joey gets a new rider, Trooper Warren.", "Joey and Topthorn are captured by the German army after a disastrous cavalry charge.", "Joey and Topthorn are cared for by Emilie and her grandfather on their French farm.", "Joey is wounded and lost in No Man's Land after Topthorn and Friedrich die."] }
            ],
            charactersMC: [
                { question: "Which of these best describes Albert Narracott's defining characteristic throughout the novel?", options: ["His ambition to become a famous soldier", "His unwavering loyalty and love for Joey", "His skill as a shrewd farmer and businessman", "His tendency to avoid difficult situations"], answer: "His unwavering loyalty and love for Joey", explanation: "Albert's entire motivation for joining the army and enduring the war is driven by his deep bond with Joey and his promise to find him." },
                { question: "Topthorn's character can be best summarized as:", options: ["Aggressive and competitive, always trying to outdo Joey", "Nervous and easily frightened by the sounds of battle", "Noble, strong, resilient, and a steadfast, calming companion to Joey", "Aloof and independent, preferring to be alone"], answer: "Noble, strong, resilient, and a steadfast, calming companion to Joey", explanation: "Topthorn is portrayed as a majestic and courageous horse who provides crucial support and friendship to Joey." },
                { question: "Emilie, the young French girl, primarily offers Joey and Topthorn:", options: ["Rigorous training for pulling carts", "A brief period of fame as 'hero horses'", "Deep affection, gentle care, and a sanctuary of peace amidst the war", "Strict discipline and minimal rations"], answer: "Deep affection, gentle care, and a sanctuary of peace amidst the war", explanation: "Emilie's love and the peaceful environment of her farm are a vital respite for the horses." },
                { question: "How does the character of Albert's father evolve from the beginning to the end of the story?", options: ["He remains a harsh and unforgiving figure throughout.", "He becomes wealthy from the farm's success during the war.", "He experiences remorse for selling Joey and becomes a kinder, more thoughtful man.", "He abandons the farm and his family."], answer: "He experiences remorse for selling Joey and becomes a kinder, more thoughtful man.", explanation: "Albert recounts to Joey that his father changed significantly, stopped his destructive habits, and treated his family better after Joey was sold." },
                { question: "Captain James Nicholls is portrayed as:", options: ["A ruthless military strategist focused only on victory", "A cynical officer who sees horses merely as tools of war", "A kind, artistic, and thoughtful man who doubts the efficacy of cavalry in modern war", "A cowardly leader who avoids battle"], answer: "A kind, artistic, and thoughtful man who doubts the efficacy of cavalry in modern war", explanation: "Captain Nicholls is gentle with Joey, an artist, and expresses his concerns about the changing nature of warfare to Joey." },
                { question: "Friedrich, the old German soldier, forms a particularly strong bond with:", options: ["Joey, because of his red coat", "The two little Haflinger ponies", "Topthorn, seeing him as a fellow old soldier", "None of the horses, he only cares for the guns"], answer: "Topthorn, seeing him as a fellow old soldier", explanation: "Friedrich develops a deep empathy and affection for Topthorn, confiding in him and caring for him meticulously." },
                { question: "Sergeant Thunder at the veterinary hospital is initially perceived as:", options: ["A bumbling and incompetent NCO", "A very soft-hearted and lenient man", "A loud, strict, and demanding figure who insists on discipline", "A corrupt official who mistreats the animals"], answer: "A loud, strict, and demanding figure who insists on discipline", explanation: "Sergeant Thunder's booming voice and insistence on standards make him appear very strict, though he later shows great compassion." },
                { question: "What is a key characteristic of Corporal Samuel Perkins's interaction with Joey?", options: ["He spoils Joey with treats and affection.", "He is terrified of Joey's spirited nature.", "He is an ex-jockey who rides hard and uses whip and spurs to assert control.", "He is a patient teacher who uses gentle persuasion."], answer: "He is an ex-jockey who rides hard and uses whip and spurs to assert control.", explanation: "Perkins is a tough, experienced horseman who believes in strict discipline and is not gentle in his methods." },
                { question: "The Welsh soldier who helps rescue Joey from No Man's Land demonstrates:", options: ["Extreme aggression towards the enemy", "A pragmatic sense of humor and shared humanity with the German soldier", "A complete lack of understanding of horses", "A desire to capture Joey for his own personal gain"], answer: "A pragmatic sense of humor and shared humanity with the German soldier", explanation: "His interaction with the German soldier is marked by a surprising camaraderie and a peaceful resolution to a potentially tense situation." },
                { question: "Major Martin, the veterinary officer, ultimately makes the decision to:", options: ["Immediately put Joey down upon diagnosing tetanus due to the low chance of survival.", "Refuse any treatment for Joey as he is just an ordinary horse.", "Allow and support the extensive, round-the-clock effort to save Joey from tetanus.", "Send Joey back to the front line despite his illness."], answer: "Allow and support the extensive, round-the-clock effort to save Joey from tetanus.", explanation: "Despite the grim prognosis, Major Martin is persuaded by Albert, David, and Sergeant Thunder to give Joey a chance, and he directs the treatment." }
            ],
            charactersTF: [ // Balanced T/F for this section
                { question: "Albert's mother is portrayed as a weak character who has little influence on family decisions.", answer: false, explanation: "Albert's mother often acts as a mediator and a voice of reason, showing quiet strength and understanding, though she cannot always prevent her husband's actions." },
                { question: "Topthorn's defining characteristic is his speed, making him faster than Joey in every encounter.", answer: false, explanation: "While Topthorn is strong and fast, the narrative suggests Joey might be slightly faster, but Topthorn excels in stamina and presence. They are well-matched companions rather than direct competitors in speed." },
                { question: "Emilie's grandfather shows no emotional attachment to Joey and Topthorn, seeing them only as farm animals.", answer: false, explanation: "Emilie's grandfather clearly develops an affection for the horses, evident in his care for them and his ultimate actions at the auction to fulfill Emilie's wish." },
                { question: "Captain Stewart is depicted as a cold and distant officer, unlike his friend Captain Nicholls.", answer: false, explanation: "Captain Stewart shows loyalty to Nicholls by caring for Joey, and he has a strong bond with his own horse, Topthorn. He is a competent and respected officer." },
                { question: "The 'butcher from Cambrai' is a sympathetic character forced into his trade by the war.", answer: false, explanation: "He is depicted with 'weasel eyes' and a 'smile so full of consummate greed and evil,' representing a grim and unwelcome fate for the horses." },
                { question: "Trooper Warren, despite his lack of riding skill, is deeply committed to Joey's well-being.", answer: true, explanation: "Joey notes that Warren's 'loving attention' kept him alive, highlighting his meticulous care despite his nervousness as a rider." },
                { question: "Herr Hauptmann, the tall German officer, is secretly working against his own army to help the British.", answer: false, explanation: "Herr Hauptmann is a loyal German officer; his kindness towards the horses stems from a sense of honor and respect for animals, not from any allegiance to the British." },
                { question: "The two golden Haflinger ponies are shown to be cowardly and unreliable under fire.", answer: false, explanation: "The Haflingers are described as courageous and hardworking, often bringing a moment of cheer despite their small size." },
                { question: "David, Albert's friend, consistently believes that Albert will find Joey.", answer: false, explanation: "While a supportive friend, David is often realistically skeptical, teasing Albert about the 'one chance in half a million' of finding Joey." },
                { question: "Maisie Cobbledick immediately bonds with Joey upon his return to the farm.", answer: false, explanation: "Joey narrates, 'I think she never took to me, nor I to her for that matter,' suggesting a lack of immediate warmth, possibly due to mutual jealousy for Albert's affection." }
            ],
            themesMC: [
                { question: "One of the most prominent themes in 'War Horse' is:", options: ["The triumph of technology in warfare", "The inherent evil of all soldiers", "The enduring bond between humans and animals, and its persistence through hardship", "The economic benefits of war for rural communities"], answer: "The enduring bond between humans and animals, and its persistence through hardship", explanation: "The core of the story revolves around the deep connections Joey forms, especially with Albert, and how these bonds provide strength and hope." },
                { question: "The novel's depiction of soldiers from different nationalities (British, German, French) primarily suggests that:", options: ["One side was inherently more virtuous than the other", "National identity is the most important aspect of a person's character", "Kindness, cruelty, and shared humanity can be found in individuals on all sides of a conflict", "Soldiers are incapable of empathy once engaged in war"], answer: "Kindness, cruelty, and shared humanity can be found in individuals on all sides of a conflict", explanation: "Joey encounters both kind and cruel individuals from every army, highlighting that character transcends nationality." },
                { question: "The theme of loss is explored in 'War Horse' through:", options: ["Only the loss of human lives in battle", "The loss of territory and strategic positions", "The death of beloved animal companions like Topthorn, the separation from loved ones, and the loss of innocence", "The financial losses suffered by farmers during wartime"], answer: "The death of beloved animal companions like Topthorn, the separation from loved ones, and the loss of innocence", explanation: "Loss is a recurring theme, manifesting in the deaths of Topthorn and Friedrich, the separation of Albert and Joey, Emilie's death, and the general loss of innocence due to war." },
                { question: "What message does the story convey about hope in the face of adversity?", options: ["Hope is a foolish emotion in wartime and usually leads to disappointment.", "Hope is a powerful, resilient force that can sustain individuals through the darkest of times.", "Hope is only relevant for humans, not for animals.", "Hope should be abandoned in favor of pragmatic realism."], answer: "Hope is a powerful, resilient force that can sustain individuals through the darkest of times.", explanation: "Albert's unwavering hope of finding Joey, and Joey's own will to survive, are central to the narrative and demonstrate hope's sustaining power." },
                { question: "The portrayal of No Man's Land in the novel serves to emphasize:", options: ["The strategic genius of trench warfare", "The beauty of nature reclaiming battlefields", "The utter desolation, danger, and dehumanizing nature of the war's front lines", "A place of secret camaraderie between opposing soldiers"], answer: "The utter desolation, danger, and dehumanizing nature of the war's front lines", explanation: "No Man's Land is depicted as a terrifying, barren wasteland, symbolizing the destructive impact of the war." },
                { question: "Through Joey's experiences with different masters and roles, the book illustrates:", options: ["The idea that animals are happiest when serving a single, consistent purpose.", "The adaptability and resilience of animals when faced with changing circumstances.", "That horses are only truly suited for farm work.", "That military life is always preferable for a strong horse."], answer: "The adaptability and resilience of animals when faced with changing circumstances.", explanation: "Joey adapts from a farm horse to a cavalry mount, an ambulance cart horse, an artillery horse, and back to a farm horse, showing incredible resilience." },
                { question: "The act of Emilie's grandfather buying Joey at the auction primarily symbolizes:", options: ["A sound financial investment for his farm", "A desire to own a famous war horse", "The fulfillment of a loving promise and the preservation of memory", "A way to spite the other bidders"], answer: "The fulfillment of a loving promise and the preservation of memory", explanation: "His purchase is driven by his promise to Emilie to care for her horses and his wish for her memory to live on." },
                { question: "The story suggests that true heroism is found in:", options: ["Aggressive combat and achieving military objectives at all costs", "Blind obedience to orders, regardless of the consequences", "Acts of compassion, loyalty, endurance, and the will to survive and protect others", "Achieving high rank and status within the military"], answer: "Acts of compassion, loyalty, endurance, and the will to survive and protect others", explanation: "The novel values acts of kindness, the strength of bonds, and perseverance over traditional notions of military glory." },
                { question: "What does the narrative imply about the nature of memory and storytelling?", options: ["Memories of war are best forgotten as quickly as possible.", "Only human memories are significant; animal experiences are fleeting.", "Storytelling and remembrance are vital for honoring those lost and for understanding the past.", "Official historical accounts are always more accurate than personal narratives."], answer: "Storytelling and remembrance are vital for honoring those lost and for understanding the past.", explanation: "The entire novel is Joey's recounted memory, and Emilie's grandfather explicitly asks Albert to tell Emilie's story so she will be remembered." },
                { question: "The contrast between the beauty of the natural world (fields, rivers, animals) and the destruction of war serves to:", options: ["Suggest that nature is indifferent to human suffering.", "Highlight the unnatural and devastating impact of human conflict on the world.", "Imply that war is a natural and inevitable part of life.", "Show that technology will always overcome nature."], answer: "Highlight the unnatural and devastating impact of human conflict on the world.", explanation: "The peaceful scenes of nature stand in stark contrast to the battlefields, emphasizing the destructive intrusion of war." }
            ],
            themesTF: [ // Balanced T/F for this section
                { question: "The novel presents war as a glorious adventure that builds character.", answer: false, explanation: "War Horse consistently portrays war as brutal, wasteful, and a source of immense suffering for both humans and animals." },
                { question: "Friendship and loyalty are presented as powerful forces capable of transcending even the horrors of war.", answer: true, explanation: "The bonds between Joey and Albert, Joey and Topthorn, and even between soldiers on opposing sides (like in No Man's Land) highlight this theme." },
                { question: "The story suggests that animals are indifferent to human conflicts and emotions.", answer: false, explanation: "Joey's narration is filled with his perceptions of human emotions, his own fear, loyalty, and grief, demonstrating deep emotional capacity." },
                { question: "A recurring message is the futility of many wartime actions and the immense waste of life.", answer: true, explanation: "Scenes like the cavalry charge against machine guns and the constant attrition underscore the senselessness and waste inherent in the conflict." },
                { question: "The novel implies that only humans are capable of acts of true cruelty.", answer: false, explanation: "While human cruelty is evident, the focus is more on the circumstances of war driving desperate actions rather than inherent evil. Some animals, like Coco, are also described with negative traits." },
                { question: "Hope is depicted as a fragile but essential element for survival in the story.", answer: true, explanation: "Albert's hope of finding Joey, and Joey's own will to live, fueled by memories and connections, are crucial for their endurance." },
                { question: "The narrative suggests that compassion is a trait exclusive to one side of the conflict.", answer: false, explanation: "Kindness is shown by British, German, and French characters, emphasizing that humanity is not defined by nationality." },
                { question: "The story ultimately argues that animals should never be used in warfare.", answer: true, explanation: "While not explicitly stated as a direct argument, the detailed depiction of the suffering and death of horses strongly implies a critique of their use in war." },
                { question: "Memory and remembrance play a vital role in honoring those lost and giving meaning to survival.", answer: true, explanation: "Joey's narration itself is an act of remembrance, and Emilie's grandfather's wish for her to be remembered underscores this theme." },
                { question: "The novel concludes with a sense that the world has learned from the war and such conflicts will never happen again.", answer: false, explanation: "The ending is more personal, focusing on Joey and Albert's return. While there's relief, there isn't a broad statement about humanity learning its lesson, reflecting the historical reality that WWI was not 'the war to end all wars.'" }
            ],
            quotesMC: [
                { question: "Who says: 'I tell you, my friend, there's divinity in a horse, and specially in a horse like this. God got it right the day he created them.'?", options: ["Albert Narracott", "Captain Nicholls", "Rudi (the young German soldier)", "Emilie's grandfather"], answer: "Rudi (the young German soldier)", explanation: "Rudi expresses this deep admiration for Topthorn to his companion Karl, shortly before Topthorn's death." },
                { question: "Identify the speaker: 'If your mother hadn't begged me last night, Albert, I'd have shot that horse on the spot. He could've killed me.'", options: ["Farmer Easton", "Albert's father", "Corporal Perkins", "The butcher from Cambrai"], answer: "Albert's father", explanation: "Albert's father says this after Joey kicks him, highlighting his anger and the precariousness of Joey's situation." },
                { question: "To whom is this said: 'You'll be all right, old son... They'll look after you, promised they would. And I need the money, Joey, I need the money bad.'?", options: ["Joey, by Albert's father when selling him", "Topthorn, by Captain Stewart", "Joey, by Albert before going to the front line", "A wounded soldier, by a medic"], answer: "Joey, by Albert's father when selling him", explanation: "Albert's father whispers this to Joey at the moment of sale, revealing his mixed emotions of remorse and desperation." },
                { question: "Who thinks/says: 'It's the mud that was killing us one by one, the mud, the lack of shelter and the lack of food.'?", options: ["Albert, about the trench conditions", "Joey (narrating), about the horses in the German artillery unit", "Emilie, about her struggle with illness", "A British infantry soldier"], answer: "Joey (narrating), about the horses in the German artillery unit", explanation: "Joey describes the horrific conditions that led to the decline and death of many horses in the gun team." },
                { question: "Complete the quote from Emilie's grandfather: 'I will sell you this horse for one English penny, and for a solemn promise - that you will always love this horse as much as my Emilie did and that you will care for him until the end of his days; and more than this, I want you to...'", options: ["...teach him many new tricks.", "...write to me every year with news of him.", "...tell everyone about my Emilie and about how she looked after your Joey...", "...never sell him, no matter what."], answer: "...tell everyone about my Emilie and about how she looked after your Joey...", explanation: "This is the poignant condition set by Emilie's grandfather to ensure her memory lives on." },
                { question: "Who exclaims: 'It's him, David. It's my Joey. I've found him. He's come back to me just like I said he would.'?", options: ["Albert's father upon seeing Joey return", "Albert Narracott", "Captain Nicholls to Captain Stewart", "Emilie's grandfather at the auction"], answer: "Albert Narracott", explanation: "Albert says this to his friend David at the veterinary hospital after confirming Joey's identity with the owl whistle." },
                { question: "The sentiment 'He's a man of his word is my father, you can be sure of that - long as he's sober' is expressed by:", options: ["Albert's mother about Albert's father", "Albert about his father", "Zoey (if she could speak) about Albert's father", "Farmer Easton about Albert's father"], answer: "Albert about his father", explanation: "Albert says this after his father agrees Joey can stay if he learns to plough, acknowledging a complex aspect of his father's character." },
                { question: "Who states: 'If I have to die out here away from my home... I would rather die alongside you.' (speaking to Topthorn)?", options: ["Joey (if he could speak human words)", "Captain Stewart", "Friedrich", "Albert Narracott"], answer: "Friedrich", explanation: "Friedrich confides this to Topthorn, showing the depth of their bond before their final, tragic day." }
            ],
            vocabularyMC: [
                { question: "In Chapter 1, Joey describes his earliest memories as a 'confusion of hilly fields and dark, damp stables.' 'Damp' means:", options: ["Brightly lit and warm", "Slightly wet; moist", "Dry and dusty", "Spacious and clean"], answer: "Slightly wet; moist", explanation: "'Damp' refers to a state of being moderately wet or humid." },
                { question: "Albert's father is described as having a voice 'harsh and thick with drink' (Chapter 1). 'Harsh' in this context means:", options: ["Soft and melodious", "Unpleasantly rough or jarring to the senses; cruel or severe", "Clear and articulate", "Quiet and hesitant"], answer: "Unpleasantly rough or jarring to the senses; cruel or severe", explanation: "A 'harsh' voice is grating and unpleasant, often implying a severe or unkind tone." },
                { question: "Joey is described as a 'gangling, leggy colt' (Chapter 1). 'Colt' refers to:", options: ["An old, experienced horse", "A female horse of any age", "A young male horse", "A small pony"], answer: "A young male horse", explanation: "A 'colt' is specifically a young male horse, generally under the age of four." },
                { question: "The soldiers on the ship to France were 'buoyant with optimism' (Chapter 6). 'Buoyant' here means:", options: ["Heavy and sinking", "Cheerful and optimistic; able to float easily", "Fearful and pessimistic", "Silent and withdrawn"], answer: "Cheerful and optimistic; able to float easily", explanation: "'Buoyant' can mean able to float, but in the context of mood, it means light-hearted, cheerful, and optimistic." },
                { question: "The landscape of No Man's Land is described as 'torn and ravaged soil' (Chapter 8). 'Ravaged' means:", options: ["Carefully cultivated and fertile", "Severely damaged; devastated", "Untouched and pristine", "Slightly disturbed but intact"], answer: "Severely damaged; devastated", explanation: "'Ravaged' indicates that something has been violently destroyed or ruined." },
                { question: "Emilie's grandfather speaks in 'hesitant English' at the auction (Chapter 20). 'Hesitant' means:", options: ["Fluent and confident", "Loud and commanding", "Tentative, unsure, or slow in acting or speaking", "Rapid and excited"], answer: "Tentative, unsure, or slow in acting or speaking", explanation: "'Hesitant' speech is characterized by pauses and uncertainty, often due to a lack of confidence or familiarity with the language." },
                { question: "The 'ominous rumble of gunfire' is heard as the war moves closer (Chapter 19). 'Ominous' means:", options: ["Giving the reassuring impression that something good will happen", "Giving the worrying impression that something bad is going to happen; threateningly inauspicious", "Faint and distant", "Joyful and celebratory"], answer: "Giving the worrying impression that something bad is going to happen; threateningly inauspicious", explanation: "'Ominous' suggests a future threat or misfortune." },
                { question: "Albert's father 'doted on' Joey after his return (Chapter 21). To 'dote on' means:", options: ["To neglect or ignore", "To be extremely and uncritically fond of", "To train rigorously", "To fear greatly"], answer: "To be extremely and uncritically fond of", explanation: "To 'dote on' someone or something is to show excessive affection and fondness." },
                { question: "The 'vagaries of the weather and the markets' are mentioned by Albert (Chapter 21). 'Vagaries' refers to:", options: ["Predictable patterns and certainties", "Unexpected and inexplicable changes in a situation or in someone's behavior", "Profitable opportunities", "Strict rules and regulations"], answer: "Unexpected and inexplicable changes in a situation or in someone's behavior", explanation: "'Vagaries' are unpredictable or erratic actions or occurrences." },
                { question: "Joey describes the 'rapturous pealing of the church bells' upon his return (Chapter 21). 'Rapturous' means:", options: ["Quiet and solemn", "Characterized by, feeling, or expressing great pleasure or enthusiasm", "Dull and monotonous", "Warning of danger"], answer: "Characterized by, feeling, or expressing great pleasure or enthusiasm", explanation: "'Rapturous' describes a feeling or expression of intense joy or delight." }
            ],
            hypotheticalMC: [
                { question: "If Albert had been old enough to enlist when Joey was first sold, how might the story have differed most significantly?", options: ["Albert would likely have become a high-ranking officer quickly.", "Joey might have had a slightly easier time in training, but the major events of the war would have been the same.", "Albert and Joey might have served together from the start, potentially altering their individual survival chances and experiences.", "Albert would have prevented Joey from ever going to war."], answer: "Albert and Joey might have served together from the start, potentially altering their individual survival chances and experiences.", explanation: "Serving together could have provided mutual support but also shared dangers, leading to a very different narrative path for both." },
                { question: "Imagine Emilie had survived the war. What role do you think she would have played in Joey's life post-war?", options: ["She would have insisted Joey stay on her farm in France, separating him from Albert permanently.", "She might have visited Joey and Albert in England, maintaining a fond connection.", "She would have forgotten about Joey as she grew older.", "She would have tried to buy Joey back from Albert."], answer: "She might have visited Joey and Albert in England, maintaining a fond connection.", explanation: "Given her deep love for Joey and her grandfather's connection with Albert, a continued, albeit long-distance, friendship seems plausible." },
                { question: "If Topthorn had not died, and both he and Joey were bought by Emilie's grandfather, what would be the most likely scenario?", options: ["The grandfather would have sold Topthorn to Albert as well for a penny.", "The grandfather would have kept both, fulfilling his promise to Emilie more completely, and Albert might have had to leave Joey in France.", "Topthorn, being so valuable, would have been sold by the grandfather for a high price to support the farm.", "Albert would have refused to take Joey if Topthorn couldn't come too."], answer: "The grandfather would have kept both, fulfilling his promise to Emilie more completely, and Albert might have had to leave Joey in France.", explanation: "The grandfather's primary motivation was his promise to Emilie regarding 'her horses' (plural). Keeping both would align with this, though it would create a difficult situation for Albert." },
                { question: "What if the coin toss in No Man's Land had resulted in the German soldier winning Joey?", options: ["Joey would have been treated cruelly and likely wouldn't have survived.", "Joey would have continued service in the German army, potentially meeting other kind individuals like Friedrich, but his reunion with Albert would be far less likely.", "The Welsh soldier would have started a fight to get Joey anyway.", "The German soldier would have immediately sold Joey for profit."], answer: "Joey would have continued service in the German army, potentially meeting other kind individuals like Friedrich, but his reunion with Albert would be far less likely.", explanation: "The German soldier showed kindness; Joey's fate would depend on his subsequent assignments, but the path to Albert would be much harder." },
                { question: "If Joey had been a less remarkable-looking horse (e.g., plain brown, no distinct markings), how might his story have changed?", options: ["His story wouldn't change at all, as his personality was most important.", "He might have been harder for Albert to identify and find, and perhaps less noticed by figures like Captain Nicholls or Herr Hauptmann.", "He would have been treated better as he wouldn't stand out.", "He would have been considered less valuable and likely sold to a butcher much earlier."], answer: "He might have been harder for Albert to identify and find, and perhaps less noticed by figures like Captain Nicholls or Herr Hauptmann.", explanation: "Joey's distinctive appearance (red bay, white cross) often drew attention and was crucial for his eventual identification by Albert." },
                { question: "Consider if Albert's father had not had a change of heart after selling Joey. How would this impact the ending of the story?", options: ["It would have no impact, as Albert would still bring Joey home.", "Albert might have faced a more difficult homecoming or been unable to keep Joey on the farm.", "Albert's father would have tried to sell Joey again upon his return.", "Albert would have chosen to stay in France with Joey."], answer: "Albert might have faced a more difficult homecoming or been unable to keep Joey on the farm.", explanation: "His father's changed nature and doting on Joey contributed to the peaceful resolution. An unchanged father could have created new conflicts." },
                { question: "If the 'butcher from Cambrai' had successfully bought Joey at the auction, what would have been Joey's most probable fate?", options: ["A comfortable retirement in the French countryside.", "Retraining as a circus horse.", "Being sold for meat.", "A long and difficult journey back to England with a new owner."], answer: "Being sold for meat.", explanation: "The term 'butcher' in this context strongly implies that horses bought by him were destined for slaughter." },
                { question: "Suppose Michael Morpurgo had written the story from Topthorn's perspective. What aspect of the war might have been emphasized differently?", options: ["The importance of Albert's promise.", "The experiences of being a highly-prized officer's mount from the outset and the bond with Captain Stewart.", "The life on Emilie's farm, as Topthorn spent less time there.", "The initial journey from England to France."], answer: "The experiences of being a highly-prized officer's mount from the outset and the bond with Captain Stewart.", explanation: "Topthorn's journey starts differently, as a valued cavalry horse. His perspective would highlight that aspect of service and his relationship with Captain Stewart more." }
            ],
            hypotheticalSO: [
                 { title: "Joey's Reunion and Return Home", sentences: ["Joey and Albert return triumphantly to their village.", "Emilie's grandfather sells Joey to Albert for a penny and a promise.", "Albert recognizes Joey at the veterinary hospital using his owl whistle.", "Joey recovers from tetanus thanks to the care of Albert and the veterinary unit."], correctOrder: ["Albert recognizes Joey at the veterinary hospital using his owl whistle.", "Joey recovers from tetanus thanks to the care of Albert and the veterinary unit.", "Emilie's grandfather sells Joey to Albert for a penny and a promise.", "Joey and Albert return triumphantly to their village."] },
                 { title: "Timeline of Key Relationships for Joey", sentences: ["Joey forms a deep bond with Topthorn in the British cavalry.", "Emilie and her grandfather provide Joey with loving care on their French farm.", "Albert Narracott is Joey's first and most profound human connection.", "Friedrich, a German soldier, shows great kindness to Joey and especially Topthorn."], correctOrder: ["Albert Narracott is Joey's first and most profound human connection.", "Joey forms a deep bond with Topthorn in the British cavalry.", "Emilie and her grandfather provide Joey with loving care on their French farm.", "Friedrich, a German soldier, shows great kindness to Joey and especially Topthorn."] }
            ]
        };

        const allQuestionSections = [
            { type: 'mc', data: quizMasterData.warmupMC, container: 'warmup-mc-container', count: 5 }, 
            { type: 'tf', data: quizMasterData.warmupTF, container: 'warmup-tf-container', count: 5 }, 
            { type: 'mc', data: quizMasterData.plotMC, container: 'plot-mc-container', count: 10 }, 
            { type: 'tf', data: quizMasterData.plotTF, container: 'plot-tf-container', count: 10 }, 
            { type: 'so', data: quizMasterData.plotSO, container: 'plot-so-container', count: 2 }, 
            { type: 'mc', data: quizMasterData.charactersMC, container: 'characters-mc-container', count: 10 }, 
            { type: 'tf', data: quizMasterData.charactersTF, container: 'characters-tf-container', count: 10 }, 
            { type: 'mc', data: quizMasterData.themesMC, container: 'themes-mc-container', count: 10 }, 
            { type: 'tf', data: quizMasterData.themesTF, container: 'themes-tf-container', count: 10 }, 
            { type: 'mc', data: quizMasterData.quotesMC, container: 'quotes-mc-container', count: 8 }, 
            { type: 'mc', data: quizMasterData.vocabularyMC, container: 'vocabulary-mc-container', count: 10 }, 
            { type: 'mc', data: quizMasterData.hypotheticalMC, container: 'hypothetical-mc-container', count: 8 }, 
            { type: 'so', data: quizMasterData.hypotheticalSO, container: 'hypothetical-so-container', count: 2 } 
        ];

        let score = 0;
        const scoreElement = document.getElementById('score');
        let questionCounter = 0; // Used to number questions sequentially

        // Global variables for touch drag-and-drop
        let g_activeTouchDraggedItem = null;
        let g_activeTouchXOffset = 0;
        let g_activeTouchYOffset = 0;

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function createQuestionCard(questionText, currentQuestionNumber) {
            const card = document.createElement('div');
            card.className = 'quiz-card p-6 md:p-8 rounded-lg';
            card.innerHTML = `<h3 class="text-2xl font-semibold mb-5">${currentQuestionNumber}. ${questionText}</h3>`;
            
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'space-y-4';
            card.appendChild(optionsContainer);
            return { card, optionsContainer };
        }

        function createMultipleChoiceQuestion(qData, containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`Container not found for MC: ${containerId}`);
                return;
            }
            questionCounter++;
            const questionId = `mcq-${questionCounter}`; // Unique ID for options of this question
            const { card, optionsContainer } = createQuestionCard(qData.question, questionCounter);

            if (!qData.options || !Array.isArray(qData.options)) {
                console.error("Malformed MC question data (missing or invalid options):", qData);
                // Optionally, append a message to the card indicating the error
                card.innerHTML += "<p class='text-red-500'>Error: Question options are missing or invalid.</p>";
                container.appendChild(card); // Still append card to show there was a question
                return; 
            }

            qData.options.forEach(optionText => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option p-4 rounded-md cursor-pointer text-lg hover:shadow-md';
                optionDiv.textContent = optionText;
                optionDiv.addEventListener('click', () => handleOptionSelect(optionDiv, qData.answer, questionId, qData.explanation, 'multipleChoice'));
                optionsContainer.appendChild(optionDiv);
            });
            container.appendChild(card);
        }

        function createTrueFalseQuestion(qData, containerId) {
            const container = document.getElementById(containerId);
             if (!container) {
                console.error(`Container not found for TF: ${containerId}`);
                return;
            }
            questionCounter++;
            const questionId = `tfq-${questionCounter}`;
            const { card, optionsContainer } = createQuestionCard(qData.question, questionCounter);

            if (typeof qData.answer !== 'boolean') {
                 console.error("Malformed TF question data (answer is not boolean):", qData);
                 card.innerHTML += "<p class='text-red-500'>Error: Question answer format is invalid.</p>";
                 container.appendChild(card);
                 return;
            }

            ['True', 'False'].forEach(optionText => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option p-4 rounded-md cursor-pointer text-lg hover:shadow-md';
                optionDiv.textContent = optionText;
                optionDiv.addEventListener('click', () => handleOptionSelect(optionDiv, qData.answer, questionId, qData.explanation, 'trueFalse'));
                optionsContainer.appendChild(optionDiv);
            });
            container.appendChild(card);
        }
        
        function handleOptionSelect(selectedDiv, correctAnswer, questionId, explanation, questionType) {
            const parentOptionsContainer = selectedDiv.parentElement;
            if (parentOptionsContainer.dataset.answered === 'true') return;

            parentOptionsContainer.dataset.answered = 'true';
            const selectedAnswerText = selectedDiv.textContent;
            let isCorrect = false;

            if (questionType === 'multipleChoice') {
                isCorrect = (selectedAnswerText === correctAnswer);
            } else if (questionType === 'trueFalse') {
                isCorrect = (selectedAnswerText === 'True' && correctAnswer === true) || (selectedAnswerText === 'False' && correctAnswer === false);
            }
            
            if (isCorrect) {
                selectedDiv.classList.add('correct');
                score++;
            } else {
                selectedDiv.classList.add('incorrect');
                Array.from(parentOptionsContainer.children).forEach(child => {
                    if (questionType === 'multipleChoice' && child.textContent === correctAnswer) {
                        child.classList.add('correct');
                    } else if (questionType === 'trueFalse' && ((child.textContent === 'True' && correctAnswer === true) || (child.textContent === 'False' && correctAnswer === false))) {
                        child.classList.add('correct');
                    }
                });
            }
            
            scoreElement.textContent = score;
            
            const explanationDiv = document.createElement('div');
            explanationDiv.className = 'explanation p-4 mt-5 rounded-md text-md';
            explanationDiv.innerHTML = `<strong class="text-[#A0522D] font-semibold">Explanation:</strong> ${explanation}`;
            parentOptionsContainer.parentElement.appendChild(explanationDiv);
        }

        function createSentenceOrderingQuestion(qData, containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`Container not found for SO: ${containerId}`);
                return;
            }
            questionCounter++;
            const questionId = `soq-${questionCounter}`;

            const card = document.createElement('div');
            card.className = 'quiz-card p-6 md:p-8 rounded-lg';
            card.innerHTML = `<h3 class="text-2xl font-semibold mb-3">${questionCounter}. ${qData.title}</h3>
                              <p class="text-gray-600 mb-6 text-md">Drag and drop the sentences into the correct chronological order. (Works with mouse and touch)</p>`;
            
            const mainFlexContainer = document.createElement('div');
            mainFlexContainer.className = 'flex flex-col md:flex-row gap-6';

            const sourceContainer = document.createElement('div');
            sourceContainer.id = `${questionId}-source`; 
            sourceContainer.className = 'w-full md:w-1/2 mb-4 md:mb-0 p-4 border border-gray-300 rounded-md source-draggable-area no-select space-y-3';
            sourceContainer.innerHTML = `<h4 class="font-semibold text-lg text-gray-700 mb-3">SENTENCES TO ORDER:</h4>`;

            const dropZone = document.createElement('div');
            dropZone.id = `drop-zone-${questionId}`;
            dropZone.className = 'w-full md:w-1/2 p-4 rounded-lg space-y-3 drop-zone no-select';
            
            if (!qData.sentences || !Array.isArray(qData.sentences) || !qData.correctOrder || !Array.isArray(qData.correctOrder)) {
                console.error("Malformed SO question data:", qData);
                card.innerHTML += "<p class='text-red-500'>Error: Sentence ordering question data is invalid.</p>";
                container.appendChild(card);
                return;
            }

            const shuffledSentences = qData.sentences.slice();
            shuffleArray(shuffledSentences);

            shuffledSentences.forEach((sentence, s_index) => {
                const draggable = document.createElement('div');
                draggable.className = 'draggable bg-gray-50 p-3 rounded-md shadow hover:shadow-md text-md';
                draggable.draggable = true; 
                draggable.textContent = sentence;
                draggable.id = `${questionId}-item-${s_index}`;
                
                draggable.addEventListener('dragstart', handleDragStart);
                draggable.addEventListener('dragend', handleDragEnd);
                draggable.addEventListener('touchstart', handleTouchStartSO, { passive: true });

                sourceContainer.appendChild(draggable);
            });

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'mt-6 text-center md:text-left';
            const checkButton = document.createElement('button');
            checkButton.textContent = 'Check Order';
            checkButton.className = 'button-primary font-semibold py-3 px-6 rounded-lg text-md shadow-md hover:shadow-lg';
            buttonContainer.appendChild(checkButton);
            
            mainFlexContainer.appendChild(sourceContainer);
            mainFlexContainer.appendChild(dropZone);
            card.appendChild(mainFlexContainer);
            card.appendChild(buttonContainer);
            container.appendChild(card);

            let currentMouseDraggedItem = null; 

            function handleDragStart(e) {
                if (!checkButton.disabled) {
                    currentMouseDraggedItem = e.target;
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                }
            }
            function handleDragEnd(e) {
                if (!checkButton.disabled && e.target.classList.contains('draggable')) { // Added check
                    e.target.classList.remove('dragging');
                    currentMouseDraggedItem = null;
                }
            }

            [sourceContainer, dropZone].forEach(area => {
                area.addEventListener('dragover', (e) => {
                    e.preventDefault(); 
                });
                area.addEventListener('drop', (e) => { 
                    e.preventDefault();
                    if (currentMouseDraggedItem && !checkButton.disabled) {
                        const targetDropArea = e.currentTarget;
                        const afterElement = getDragAfterElementSO(targetDropArea, e.clientY);
                        if (afterElement == null) {
                            targetDropArea.appendChild(currentMouseDraggedItem);
                        } else {
                            targetDropArea.insertBefore(currentMouseDraggedItem, afterElement);
                        }
                        // No need to remove 'dragging' here, dragend will handle it.
                    }
                });
            });
            
            function handleTouchStartSO(e) {
                const touchedEl = e.currentTarget; 
                if (touchedEl && !checkButton.disabled) {
                    g_activeTouchDraggedItem = touchedEl; 
                    g_activeTouchDraggedItem.classList.add('touch-dragging'); 
                    
                    const rect = g_activeTouchDraggedItem.getBoundingClientRect();
                    g_activeTouchXOffset = e.touches[0].clientX - rect.left;
                    g_activeTouchYOffset = e.touches[0].clientY - rect.top;
                    
                    document.body.classList.add('no-select'); 
                }
            }
            
            function getDragAfterElementSO(container, y) {
                const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging):not(.touch-dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }
            
            checkButton.addEventListener('click', () => {
                if (card.dataset.answered === 'true') return;
                card.dataset.answered = 'true';
                
                const droppedItems = Array.from(dropZone.children).map(child => child.textContent);
                const isCorrect = JSON.stringify(droppedItems) === JSON.stringify(qData.correctOrder);
                
                checkButton.disabled = true;
                card.querySelectorAll('.draggable').forEach(el => {
                    el.draggable = false; 
                    el.classList.remove('touch-dragging', 'dragging');
                });
                
                const resultDiv = document.createElement('div');
                resultDiv.className = 'p-4 mt-5 rounded-md text-md';
                
                if (isCorrect) {
                    score++;
                    scoreElement.textContent = score;
                    resultDiv.classList.add('bg-green-100', 'border-l-4', 'border-green-500', 'text-green-700');
                    resultDiv.innerHTML = `<strong class="font-bold">Correct!</strong> You've ordered the events perfectly.`;
                } else {
                    resultDiv.classList.add('bg-red-100', 'border-l-4', 'border-red-500', 'text-red-700');
                    let correctOrderHtml = qData.correctOrder.map((item, i) => `<li class="ml-4">${i+1}. ${item}</li>`).join('');
                    resultDiv.innerHTML = `<strong class="font-bold">Not quite.</strong> This is the correct order: <ol class="list-decimal list-inside mt-2">${correctOrderHtml}</ol>`;
                }
                card.appendChild(resultDiv);
            });
        }

        document.addEventListener('touchmove', (e) => {
            if (g_activeTouchDraggedItem) {
                e.preventDefault();
            }
        }, { passive: false });

        document.addEventListener('touchend', (e) => {
            if (g_activeTouchDraggedItem) {
                g_activeTouchDraggedItem.classList.remove('touch-dragging');
                document.body.classList.remove('no-select');

                const touchX = e.changedTouches[0].clientX;
                const touchY = e.changedTouches[0].clientY;
                
                const allDropAreas = document.querySelectorAll('.drop-zone, .source-draggable-area');
                let targetContainer = null;

                for (const area of allDropAreas) {
                    const rect = area.getBoundingClientRect();
                    if (touchX >= rect.left && touchX <= rect.right && touchY >= rect.top && touchY <= rect.bottom) {
                        if (g_activeTouchDraggedItem.closest('.quiz-card').contains(area)) {
                            targetContainer = area;
                            break;
                        }
                    }
                }
                
                if (targetContainer) {
                    const afterElement = getDragAfterElementGlobal(targetContainer, touchY);
                    if (afterElement == null) {
                        targetContainer.appendChild(g_activeTouchDraggedItem);
                    } else {
                        targetContainer.insertBefore(g_activeTouchDraggedItem, afterElement);
                    }
                } else { 
                    const questionCard = g_activeTouchDraggedItem.closest('.quiz-card');
                    if (questionCard) {
                        const originalSourceContainer = questionCard.querySelector('.source-draggable-area');
                        if (originalSourceContainer) {
                            originalSourceContainer.appendChild(g_activeTouchDraggedItem);
                        }
                    }
                }
                g_activeTouchDraggedItem = null;
            }
        });
        
        function getDragAfterElementGlobal(container, y) {
            const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging):not(.touch-dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function buildQuiz() {
            questionCounter = 0; 
            score = 0; 
            scoreElement.textContent = score;

            allQuestionSections.forEach(section => {
                const container = document.getElementById(section.container);
                if (!container) {
                    console.error(`BuildQuiz: Container element ${section.container} not found.`);
                    return; // Skip this section if container doesn't exist
                }

                const dataArray = section.data.slice(); 
                shuffleArray(dataArray);
                const numQuestionsToDisplay = Math.min(section.count, dataArray.length);
                const questionsForSection = dataArray.slice(0, numQuestionsToDisplay);

                questionsForSection.forEach(qData => {
                    if (!qData || typeof qData.question !== 'string' ) { // Basic check for qData validity
                        console.warn("Skipping malformed question data:", qData);
                        return;
                    }
                    if (section.type === 'mc') {
                        createMultipleChoiceQuestion(qData, section.container);
                    } else if (section.type === 'tf') {
                        createTrueFalseQuestion(qData, section.container);
                    } else if (section.type === 'so') {
                        createSentenceOrderingQuestion(qData, section.container);
                    }
                });
            });
            document.getElementById('total-questions').textContent = questionCounter;
        }
        
        document.getElementById('reset-quiz').addEventListener('click', () => {
            allQuestionSections.forEach(section => {
                 const container = document.getElementById(section.container);
                 if(container) container.innerHTML = '';
            });
            buildQuiz(); 
        });

        buildQuiz(); 
    </script>
</body>
</html>
